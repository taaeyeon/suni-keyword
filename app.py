# -*- coding: utf-8 -*-
"""app

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/13RenjSRRvfr59t-36tHRhVXpCTPQxcZU
"""

import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt
from collections import Counter
import re
from wordcloud import WordCloud
import matplotlib.font_manager as fm

# âœ… ê¸°ë³¸ ì„¤ì •
st.set_page_config(page_title="í‚¤ì›Œë“œ ë¶„ì„", layout="wide")
st.title("ğŸ“Š SUNI í‚¤ì›Œë“œ ë¶„ì„ ëŒ€ì‹œë³´ë“œ")

# âœ… í•œê¸€ í°íŠ¸ ì„¤ì • (ì›Œë“œí´ë¼ìš°ë“œ + matplotlib ê³µí†µ ì‚¬ìš©)
FONT_PATH = "NanumGothic.ttf"
font_prop = fm.FontProperties(fname=FONT_PATH)
plt.rcParams['font.family'] = font_prop.get_name()

# âœ… íŒŒì¼ ì—…ë¡œë“œ
uploaded_file = st.file_uploader("ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš” (.xlsx)", type="xlsx")

# âœ… ë¶„ì„ ìœ í˜• ì„ íƒ
analysis_type = st.radio("ë¶„ì„ ìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš”", ["ì „ì‚¬", "ì§ë¬´ë³„"])

# âœ… ë¶ˆìš©ì–´ ë¦¬ìŠ¤íŠ¸
stopwords = set([
    'ìœ„í•´', 'ê´€ë ¨', 'ê°•í™”', 'ê¸°ë°˜', 'ë°', 'ìˆ˜ì¤€', 'í•„ìš”', 'ì œì•ˆ', 'ë°©ì•ˆ', 'í™œìš©',
    'ì°¸ì„', 'êµìœ¡', 'ì§„í–‰', 'ì—­ëŸ‰', 'ë‚´ìš©', 'ì´í•´', 'ì œê³ ', 'í™•ë³´', 'ëŒ€í•œ', 'ìˆìŠµë‹ˆë‹¤',
    'ìˆë„ë¡', 'ìœ„í•œ', 'í•˜ê³ ', 'ì‹¶ìŠµë‹ˆë‹¤', 'í•©ë‹ˆë‹¤', 'í†µí•´', 'í•œë²ˆ', 'í•˜ëŠ”', 'ê°™ì€', 'ë³´ì—¬', 'ëœë‹¤', 'ìˆ˜í–‰'
])

# âœ… í‚¤ì›Œë“œ ì¶”ì¶œ í•¨ìˆ˜
def extract_keywords(texts):
    text = ' '.join(texts)
    text = re.sub(r"[^ê°€-í£\s]", "", text)
    words = text.split()
    filtered = [w for w in words if w not in stopwords and len(w) > 1]
    return Counter(filtered)

# âœ… ì‹œê°í™” í•¨ìˆ˜
def draw_charts(title, freq_dict):
    col1, col2, col3 = st.columns(3)

    # ë§‰ëŒ€ê·¸ë˜í”„
    with col1:
        st.markdown(f"**ğŸ“Š {title} - ë§‰ëŒ€ê·¸ë˜í”„**")
        fig, ax = plt.subplots(figsize=(4, 3))  # ğŸ‘ˆ ì‘ê²Œ ì¡°ì •
        ax.bar(freq_dict.keys(), freq_dict.values(), color='skyblue')
        plt.xticks(rotation=45, fontsize=8)
        plt.yticks(fontsize=8)
        st.pyplot(fig)

    # íŒŒì´ì°¨íŠ¸
    with col2:
        st.markdown(f"**ğŸ§ {title} - íŒŒì´ì°¨íŠ¸**")
        fig, ax = plt.subplots(figsize=(4, 3))  # ğŸ‘ˆ ì‘ê²Œ ì¡°ì •
        ax.pie(freq_dict.values(), labels=freq_dict.keys(), autopct='%1.1f%%', startangle=140, textprops={'fontsize': 8})
        st.pyplot(fig)

    # ì›Œë“œí´ë¼ìš°ë“œ
    with col3:
        st.markdown(f"**â˜ï¸ {title} - ì›Œë“œí´ë¼ìš°ë“œ**")
        wc = WordCloud(font_path=FONT_PATH, background_color='white', width=300, height=200)  # ğŸ‘ˆ ì‘ê²Œ ì¡°ì •
        wc.generate_from_frequencies(freq_dict)
        fig, ax = plt.subplots(figsize=(4, 3))  # ğŸ‘ˆ ì‘ê²Œ ì¡°ì •
        ax.imshow(wc, interpolation='bilinear')
        ax.axis("off")
        st.pyplot(fig)

# âœ… ë¶„ì„ ì‹¤í–‰
if uploaded_file:
    df = pd.read_excel(uploaded_file)
    df_focus = df.copy()

    if 'ì§ë¬´' not in df_focus.columns or '(2) ì„±ì¥/ì—­ëŸ‰/ì»¤ë¦¬ì–´-êµ¬ì„±ì› ì˜ê²¬' not in df_focus.columns:
        st.error("ì—‘ì…€ íŒŒì¼ì— 'ì§ë¬´' ë° '(2) ì„±ì¥/ì—­ëŸ‰/ì»¤ë¦¬ì–´-êµ¬ì„±ì› ì˜ê²¬' ì»¬ëŸ¼ì´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.")
    else:
        if analysis_type == "ì „ì‚¬":
            texts = df_focus['(2) ì„±ì¥/ì—­ëŸ‰/ì»¤ë¦¬ì–´-êµ¬ì„±ì› ì˜ê²¬'].dropna().tolist()
            counter = extract_keywords(texts)
            top50 = dict(counter.most_common(50))
            draw_charts("ì „ì‚¬ í‚¤ì›Œë“œ", top50)
        else:
            results = []
            for job, group in df_focus.groupby("ì§ë¬´"):
                texts = group['(2) ì„±ì¥/ì—­ëŸ‰/ì»¤ë¦¬ì–´-êµ¬ì„±ì› ì˜ê²¬'].dropna().tolist()
                counter = extract_keywords(texts)
                top10 = dict(counter.most_common(10))
                results.append((job, top10))

            for job, freq_dict in results:
                st.markdown(f"### ğŸ” ì§ë¬´: {job}")
                draw_charts(job, freq_dict)